<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShortsUp PRO - Secure Version</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coi-serviceworker/0.1.7/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
    <style>
        :root { --primary: #007AFF; --bg: #0f0f0f; --card: #1e1e1e; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #editor-view { width: 320px; height: 568px; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .ui-container { width: 320px; margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        input, select, button { padding: 12px; border-radius: 8px; border: none; font-size: 14px; outline: none; }
        input { background: var(--card); color: white; border: 1px solid #333; }
        button { background: var(--primary); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; cursor: not-allowed; }
        /* 설정 모달 스타일 */
        #settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: var(--card); padding: 25px; border-radius: 15px; width: 300px; display: flex; flex-direction: column; gap: 15px; }
        #status-log { font-size: 12px; color: #aaa; text-align: center; margin-top: 10px; min-height: 35px; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 10px;">ShortsUp PRO</h2>
    
    <div id="editor-view"><canvas id="main-canvas"></canvas></div>

    <div class="ui-container">
        <input type="text" id="topic-input" placeholder="영상 주제를 입력하세요">
        <button id="btn-generate" onclick="handleGenerate()">1. AI 시나리오 기획</button>
        <button id="btn-export" onclick="handleExport()" disabled>2. 영상 생성 및 다운로드</button>
        <button style="background: #333; font-size: 12px;" onclick="showSettings()">⚙️ API 키 설정</button>
        <div id="status-log">키 설정을 완료한 후 시작하세요.</div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <h3 style="margin:0">보안 설정</h3>
            <p style="font-size: 12px; color: #aaa;">키는 브라우저에만 저장되며 외부로 노출되지 않습니다.</p>
            <input type="password" id="key-gemini" placeholder="Gemini API Key">
            <input type="password" id="key-pexels" placeholder="Pexels API Key">
            <button onclick="saveKeys()">설정 저장하기</button>
        </div>
    </div>

    <script>
        // 코드에 키를 절대 적지 않습니다!
        let CONFIG = { GEMINI_KEY: "", PEXELS_KEY: "" };

        const canvas = new fabric.Canvas('main-canvas', { width: 320, height: 568 });
        let currentScript = null;
        let ffmpegInstance = null;

        // 페이지 로드 시 저장된 키 확인
        window.onload = () => {
            const savedG = localStorage.getItem('sh_gemini');
            const savedP = localStorage.getItem('sh_pexels');
            if(!savedG || !savedP) showSettings();
            else { CONFIG.GEMINI_KEY = savedG; CONFIG.PEXELS_KEY = savedP; }
        };

        function showSettings() { document.getElementById('settings-modal').style.display = 'flex'; }
        
        function saveKeys() {
            const g = document.getElementById('key-gemini').value;
            const p = document.getElementById('key-pexels').value;
            if(!g || !p) return alert("두 키를 모두 입력해주세요.");
            localStorage.setItem('sh_gemini', g);
            localStorage.setItem('sh_pexels', p);
            CONFIG.GEMINI_KEY = g; CONFIG.PEXELS_KEY = p;
            document.getElementById('settings-modal').style.display = 'none';
            log("키 설정이 완료되었습니다.");
        }

        async function handleGenerate() {
            const topic = document.getElementById('topic-input').value;
            if(!topic) return alert("주제를 입력해주세요.");
            if(!CONFIG.GEMINI_KEY) return showSettings();

            toggleUI(true, "AI가 기획 중...");
            try {
                const prompt = `주제 "${topic}"로 한국어 쇼츠 대본 작성. 15초 이내. JSON으로만 출력: {"total_duration":15, "scenes":[{"start":0, "end":15, "text":"자막", "visual_prompt":"sea"}]}`;
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_KEY}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const resData = await response.json();
                const rawText = resData.candidates[0].content.parts[0].text;
                currentScript = JSON.parse(rawText.match(/\{[\s\S]*\}/)[0]);

                for (let scene of currentScript.scenes) {
                    scene.imageUrl = await getStockImage(scene.visual_prompt);
                }
                drawPreview(0);
                log("기획 완료! 생성 버튼을 누르세요.");
                document.getElementById('btn-export').disabled = false;
            } catch (err) { log("오류: 키가 올바른지 확인하세요."); }
            finally { toggleUI(false); }
        }

        async function handleExport() {
            if(!currentScript) return;
            toggleUI(true, "영상 제작 중...");
            try {
                if(!ffmpegInstance) {
                    ffmpegInstance = new FFmpeg.FFmpeg();
                    await ffmpegInstance.load({
                        coreURL: await FFmpegUtil.toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js', 'text/javascript'),
                        wasmURL: await FFmpegUtil.toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm', 'application/wasm'),
                    });
                }
                const fps = 10;
                const totalFrames = Math.floor(currentScript.total_duration * fps);
                for (let i = 0; i < totalFrames; i++) {
                    await drawPreview(i / fps);
                    const frameData = canvas.toDataURL('image/jpeg', 0.6);
                    await ffmpegInstance.writeFile(`f${i}.jpg`, await FFmpegUtil.fetchFile(frameData));
                }
                await ffmpegInstance.exec(['-framerate', '10', '-i', 'f%d.jpg', '-c:v', 'libx264', '-preset', 'ultrafast', 'out.mp4']);
                const data = await ffmpegInstance.readFile('out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                const a = document.createElement('a'); a.href = url; a.download = `shorts_${Date.now()}.mp4`; a.click();
                log("성공! 다운로드되었습니다.");
            } catch (err) { log("제작 실패"); }
            finally { toggleUI(false); }
        }

        async function drawPreview(time) {
            canvas.clear();
            const scene = currentScript.scenes[0];
            return new Promise(resolve => {
                fabric.Image.fromURL(scene.imageUrl, (img) => {
                    const scale = Math.max(canvas.width/img.width, canvas.height/img.height);
                    img.set({ scaleX: scale, scaleY: scale, originX: 'center', originY: 'center', left: 160, top: 284 });
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    canvas.add(new fabric.Textbox(scene.text, { width: 280, top: 400, left: 160, originX: 'center', textAlign: 'center', fill: '#fff', fontSize: 20, backgroundColor: 'rgba(0,0,0,0.6)' }));
                    resolve();
                }, { crossOrigin: 'anonymous' });
            });
        }

        async function getStockImage(q) {
            const res = await fetch(`https://api.pexels.com/v1/search?query=${q}&per_page=1`, { headers: { Authorization: CONFIG.PEXELS_KEY } });
            const data = await res.json();
            return data.photos[0]?.src?.large2x || "";
        }

        function toggleUI(l, m) { document.getElementById('btn-generate').disabled = l; if(m) log(m); }
        function log(m) { document.getElementById('status-log').innerText = m; }
    </script>
</body>
</html>