<!DOCTYPE html>
<html lang="ko">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coi-serviceworker/0.1.7/coi-serviceworker.min.js"></script>
    <meta charset="UTF-8">
    <title>AI Shorts Pro Maker</title>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.min.js"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #121212; color: white; display: flex; flex-direction: column; align-items: center; }
        #canvas-wrapper { width: 360px; height: 640px; border: 2px solid #333; margin-top: 20px; overflow: hidden; position: relative; }
        .ui-panel { width: 360px; margin-top: 20px; display: flex; flex-direction: column; gap: 10px; }
        input, select, button { padding: 12px; border-radius: 8px; border: none; font-size: 16px; }
        button { background: #007AFF; color: white; font-weight: bold; cursor: pointer; }
        button:disabled { background: #444; }
        #log { font-size: 12px; color: #aaa; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>AI Shorts Pro</h1>
    <div id="canvas-wrapper"><canvas id="canvas"></canvas></div>
    <div class="ui-panel">
        <input type="text" id="topic" placeholder="쇼츠 주제 (예: 1분 명상 팁)">
        <select id="language">
            <option value="ko-KR">한국어</option>
            <option value="en-US">English</option>
        </select>
        <button id="main-btn" onclick="runWorkflow()">쇼츠 자동 생성 시작</button>
        <button id="export-btn" onclick="exportShorts()" disabled>영상 내보내기 (MP4)</button>
        <div id="log">준비 완료</div>
    </div>

    <script>
        // API 설정 (실제 사용 시 본인의 키로 교체)
        const GEMINI_KEY = "YOUR_GEMINI_API_KEY";
        const PEXELS_KEY = "YOUR_PEXELS_API_KEY";
        
        const canvas = new fabric.Canvas('canvas', { width: 360, height: 640 });
        let currentScript = null;

        // 1. 통합 워크플로우 실행
        async function runWorkflow() {
            const topic = document.getElementById('topic').value;
            const lang = document.getElementById('language').value;
            updateLog("AI 시나리오 구성 중...");

            // [1] Gemini 스크립트 생성 (바이럴 최적화 포함)
            const script = await getGeminiData(topic, lang);
            currentScript = script;

            // [2] 배경 이미지 및 테마 적용
            updateLog("배경 이미지 매칭 중...");
            for (let scene of script.scenes) {
                scene.bgImage = await fetchPexelsImage(scene.visual_prompt);
            }

            // [3] 미리보기 렌더링
            renderScene(0); 
            updateLog(`제작 완료 (예상 길이: ${script.total_duration}초)`);
            document.getElementById('export-btn').disabled = false;
        }

        // Gemini API 호출 (1단계 & 2단계 통합)
        async function getGeminiData(topic, lang) {
            const prompt = `주제 "${topic}"로 ${lang} 쇼츠 대본을 써줘. 
            8~60초 이내로 구성하고, 결과는 JSON으로만 줘: 
            {"total_duration":초, "theme":{"bg":"#hex","txt":"#hex"}, "scenes":[{"start":0, "end":5, "text":"자막", "visual_prompt":"이미지 검색어"}]}`;
            
            const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_KEY}`, {
                method: 'POST',
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const json = await resp.json();
            return JSON.parse(json.candidates[0].content.parts[0].text);
        }

        // Pexels API 호출 (6단계)
        async function fetchPexelsImage(query) {
            const resp = await fetch(`https://api.pexels.com/v1/search?query=${query}&per_page=1`, {
                headers: { Authorization: PEXELS_KEY }
            });
            const data = await resp.json();
            return data.photos[0].src.large;
        }

        function updateLog(msg) { document.getElementById('log').innerText = msg; }
        
        function renderScene(index) {
            const scene = currentScript.scenes[index];
            fabric.Image.fromURL(scene.bgImage, (img) => {
                canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
                    scaleX: canvas.width / img.width, scaleY: canvas.height / img.height
                });
                const txt = new fabric.Textbox(scene.text, {
                    width: 300, top: 500, left: 180, originX: 'center',
                    fill: currentScript.theme.txt, fontSize: 24, textAlign: 'center',
                    backgroundColor: 'rgba(0,0,0,0.5)'
                });
                canvas.add(txt);
            }, { crossOrigin: 'anonymous' });
        }
        
        // 3. 비디오 추출 (FFmpeg.wasm)
        async function exportShorts() {
            updateLog("인코딩 시작... 잠시만 기다려주세요.");
            // FFmpeg 로직 구현 (생략 - 이전 단계 참조)
        }
    </script>
</body>
</html>