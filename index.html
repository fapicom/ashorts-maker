<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Shorts Maker PRO - ShortsUp & PIX Up</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/coi-serviceworker/0.1.7/coi-serviceworker.min.js"></script>
    <script src="https://unpkg.com/fabric@5.3.0/dist/fabric.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.7/dist/umd/ffmpeg.min.js"></script>
    <script src="https://unpkg.com/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>

    <style>
        :root { --primary: #007AFF; --bg: #0f0f0f; --card: #1e1e1e; }
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: white; display: flex; flex-direction: column; align-items: center; margin: 0; padding: 20px; }
        #editor-view { width: 360px; height: 640px; background: #000; border-radius: 12px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); position: relative; }
        .ui-container { width: 360px; margin-top: 20px; display: flex; flex-direction: column; gap: 12px; }
        input, select, button { padding: 14px; border-radius: 10px; border: none; font-size: 15px; outline: none; }
        input { background: var(--card); color: white; border: 1px solid #333; }
        button { background: var(--primary); color: white; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        button:disabled { background: #444; cursor: not-allowed; transform: none; }
        #progress-wrap { width: 100%; height: 6px; background: #333; border-radius: 3px; display: none; margin-top: 10px; }
        #progress-bar { height: 100%; width: 0%; background: var(--primary); transition: width 0.2s; }
        #status-log { font-size: 13px; color: #aaa; text-align: center; min-height: 40px; line-height: 1.5; }
        .error-text { color: #ff4d4d; font-weight: bold; }
    </style>
</head>
<body>

    <h2 style="margin-bottom: 10px;">AI Shorts Maker PRO</h2>
    
    <div id="editor-view">
        <canvas id="main-canvas"></canvas>
    </div>

    <div class="ui-container">
        <input type="text" id="topic-input" placeholder="주제를 입력하세요 (예: 푸들이 간식 먹는 법)">
        <select id="lang-select">
            <option value="ko-KR">한국어</option>
            <option value="en-US">English</option>
        </select>
        
        <button id="btn-generate" onclick="handleGenerate()">1. AI 시나리오 기획</button>
        <button id="btn-export" onclick="handleExport()" disabled>2. 영상 생성 및 다운로드</button>
        
        <div id="progress-wrap"><div id="progress-bar"></div></div>
        <div id="status-log">주제를 입력하고 시작하세요.</div>
    </div>

    <script>
        /*********************************************************
         * ⚠️ [필독] 여기에 본인의 API 키를 입력하세요! ⚠️
         *********************************************************/
        const CONFIG = {
            // 1. Gemini 키 (v1 API 사용 예정)
            GEMINI_KEY: "AIzaSyBhyoJb_G7okUhtly-EHNIcsSvC-w5BGJg
", 

            // 2. Pexels 키
            PEXELS_KEY: "RoENgvlFuwNUfjxMbeMxUguWn8ENueJFWGDSj2kfHaBHok0xlnV7SyLT"
        };
        /*********************************************************/

        const canvas = new fabric.Canvas('main-canvas', { width: 360, height: 640 });
        let currentScript = null;
        let ffmpegInstance = null;

        // --- 기능 1: AI 시나리오 및 에셋 구성 ---
        async function handleGenerate() {
            const topic = document.getElementById('topic-input').value;
            if(!topic) return alert("주제를 입력해주세요.");
            if(CONFIG.GEMINI_KEY.includes("입력하세요")) return alert("API 키를 먼저 입력해주세요.");

            toggleUI(true, "AI가 시나리오를 구성하고 있습니다...");

            try {
                const lang = document.getElementById('lang-select').value;
                const prompt = `주제 "${topic}"로 ${lang} 쇼츠 대본 작성. 15~30초 이내. 
                결과는 반드시 순수한 JSON 객체 하나만 출력해. 다른 설명은 절대 금지.
                형식: {"total_duration":초, "scenes":[{"start":초, "end":초, "text":"자막내용", "visual_prompt":"ocean"}]}`;

                // v1beta 오류를 수정한 v1 API 주소 사용
                const response = await fetch(`https://generativelanguage.googleapis.com/v1/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                
                const resData = await response.json();
                if(!response.ok) throw new Error(resData.error?.message || "API 연결 실패");

                let rawText = resData.candidates[0].content.parts[0].text;
                const jsonMatch = rawText.match(/\{[\s\S]*\}/);
                if (!jsonMatch) throw new Error("JSON 데이터를 찾을 수 없습니다.");
                
                currentScript = JSON.parse(jsonMatch[0]);

                log(`시나리오 완성! (${currentScript.total_duration}초) 이미지를 매칭 중...`);

                // 이미지 검색 및 로드
                for (let scene of currentScript.scenes) {
                    scene.imageUrl = await getStockImage(scene.visual_prompt);
                }

                await drawPreview(0);
                log("기획 완료! '영상 생성' 버튼을 눌러주세요.");
                document.getElementById('btn-export').disabled = false;

            } catch (err) {
                log(`<span class="error-text">오류: ${err.message}</span>`);
                console.error(err);
            } finally {
                toggleUI(false);
            }
        }

        // --- 기능 2: 영상 렌더링 및 인코딩 ---
        async function handleExport() {
            if(!currentScript) return;
            toggleUI(true, "영상을 제작 중입니다. 창을 닫지 마세요.");
            document.getElementById('progress-wrap').style.display = 'block';

            try {
                if(!ffmpegInstance) {
                    ffmpegInstance = new FFmpeg.FFmpeg();
                    await ffmpegInstance.load({
                        coreURL: await FFmpegUtil.toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.js', 'text/javascript'),
                        wasmURL: await FFmpegUtil.toBlobURL('https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd/ffmpeg-core.wasm', 'application/wasm'),
                    });
                }

                const fps = 12; // 최적화된 프레임 속도
                const totalFrames = Math.floor(currentScript.total_duration * fps);

                for (let i = 0; i < totalFrames; i++) {
                    const time = i / fps;
                    await drawPreview(time);
                    
                    // 실시간 생성 모습 표시를 위한 지연
                    await new Promise(r => setTimeout(r, 10)); 

                    const frameData = canvas.toDataURL('image/jpeg', 0.7);
                    await ffmpegInstance.writeFile(`f${i}.jpg`, await FFmpegUtil.fetchFile(frameData));
                    
                    updateProgress((i / totalFrames) * 100);
                }

                log("인코딩 최종 마무리 중...");
                await ffmpegInstance.exec([
                    '-framerate', `${fps}`, '-i', 'f%d.jpg',
                    '-c:v', 'libx264', '-preset', 'ultrafast', '-pix_fmt', 'yuv420p',
                    'out.mp4'
                ]);

                const data = await ffmpegInstance.readFile('out.mp4');
                const url = URL.createObjectURL(new Blob([data.buffer], { type: 'video/mp4' }));
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `shorts_${Date.now()}.mp4`;
                a.click();

                log("성공! 영상이 다운로드되었습니다.");
            } catch (err) {
                log(`<span class="error-text">제작 실패: ${err.message}</span>`);
                console.error(err);
            } finally {
                toggleUI(false);
                setTimeout(() => document.getElementById('progress-wrap').style.display = 'none', 3000);
            }
        }

        // --- 보조 도구들 ---
        async function drawPreview(time) {
            canvas.clear();
            const scene = currentScript.scenes.find(s => time >= s.start && time < s.end) || currentScript.scenes[0];
            
            return new Promise(resolve => {
                fabric.Image.fromURL(scene.imageUrl, (img) => {
                    const scale = Math.max(canvas.width / img.width, canvas.height / img.height);
                    img.set({ scaleX: scale, scaleY: scale, originX: 'center', originY: 'center', left: 180, top: 320 });
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                    
                    const txt = new fabric.Textbox(scene.text, {
                        width: 300, top: 480, left: 180, originX: 'center', textAlign: 'center',
                        fill: '#fff', fontSize: 24, fontWeight: 'bold', backgroundColor: 'rgba(0,0,0,0.6)',
                        padding: 10, cornerRadius: 10
                    });
                    canvas.add(txt);
                    resolve();
                }, { crossOrigin: 'anonymous' });
            });
        }

        async function getStockImage(q) {
            try {
                const res = await fetch(`https://api.pexels.com/v1/search?query=${q}&per_page=1`, {
                    headers: { Authorization: CONFIG.PEXELS_KEY }
                });
                const data = await res.json();
                return data.photos[0]?.src?.large2x || "https://via.placeholder.com/1080x1920?text=No+Image";
            } catch { return "https://via.placeholder.com/1080x1920?text=Error"; }
        }

        function toggleUI(load, msg) {
            document.getElementById('btn-generate').disabled = load;
            if(msg) log(msg);
        }
        function log(m) { document.getElementById('status-log').innerHTML = m; }
        function updateProgress(p) { document.getElementById('progress-bar').style.width = `${p}%`; }
    </script>
</body>
</html>